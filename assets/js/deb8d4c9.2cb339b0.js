(window.webpackJsonp=window.webpackJsonp||[]).push([[198],{305:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return s}));var a=n(3),o=n(8),r=(n(0),n(338)),i={id:"openapi",title:"OpenAPI / Swagger",sidebar_label:"OpenAPI / Swagger"},l={unversionedId:"handlers/openapi",id:"handlers/openapi",isDocsHomePage:!1,title:"OpenAPI / Swagger",description:"image",source:"@site/docs/handlers/openapi.md",slug:"/handlers/openapi",permalink:"/docs/handlers/openapi",editUrl:"https://github.com/urigo/graphql-mesh/edit/master/website/docs/handlers/openapi.md",version:"current",sidebar_label:"OpenAPI / Swagger",sidebar:"sidebar",previous:{title:"GraphQL",permalink:"/docs/handlers/graphql"},next:{title:"gRPC & Protobuf",permalink:"/docs/handlers/grpc"}},c=[{value:"Overriding default Query/Mutation operations",id:"overriding-default-querymutation-operations",children:[]},{value:"Dynamic Header Values",id:"dynamic-header-values",children:[{value:"From Context (HTTP Header for <code>mesh serve</code>)",id:"from-context-http-header-for-mesh-serve",children:[]},{value:"From Environmental Variable",id:"from-environmental-variable",children:[]}]},{value:"Advanced cookies handling",id:"advanced-cookies-handling",children:[{value:"Accepting either a cookie or a header",id:"accepting-either-a-cookie-or-a-header",children:[]},{value:"Setting / Unsetting the cookie",id:"setting--unsetting-the-cookie",children:[]}]},{value:"Config API Reference",id:"config-api-reference",children:[]}],p={toc:c};function s(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,Object(r.b)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/20847995/79218686-7ba7b900-7e59-11ea-8a5e-676a83b9f86e.png",alt:"image"})),Object(r.b)("p",null,"This handler allows you to load remote or local ",Object(r.b)("a",{parentName:"p",href:"https://swagger.io/"},"OpenAPI (2/3) and Swagger")," schemas. Based on ",Object(r.b)("a",{parentName:"p",href:"https://developer.ibm.com/open/projects/openapi-to-graphql/"},"OpenAPI-to-GraphQL"),"."),Object(r.b)("p",null,"You can import it using remote/local ",Object(r.b)("inlineCode",{parentName:"p"},".json")," or ",Object(r.b)("inlineCode",{parentName:"p"},".yaml"),"."),Object(r.b)("p",null,"To get started, install the handler library from NPM:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},"$ yarn add @graphql-mesh/openapi\n")),Object(r.b)("p",null,"Now, you can use it directly in your Mesh config file:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yml"},"sources:\n  - name: MyOpenapiApi\n    handler:\n      openapi:\n        source: ./my-schema.json\n")),Object(r.b)("h2",{id:"overriding-default-querymutation-operations"},"Overriding default Query/Mutation operations"),Object(r.b)("p",null,"By default OpenAPI-to-GraphQL will place all GET operations into Query fields and all other operations into Mutation fields; with this option you can manually override this process.\nIn order to switch between Query and Mutation operations, and vice versa, you need to define a rule per override, consisting of: OAS title, path of the operation, method of the operation and finally the destination type (e.g. Query or Mutation).\nSee example below:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},'sources:\n  - name: MyOpenapiApi\n    handler:\n      openapi:\n        source: ./my-schema.json\n        selectQueryOrMutationField:\n          - title: "Weather Service v1" # OAS title\n            path: /weather/current # operation path\n            method: post\n            type: Query # switch method POST from default Mutation into Query\n          - title: "Weather Service v1" # OAS title\n            path: /weather/forecast # operation path\n            method: get\n            type: Mutation # switch method GET from default Query into Mutation\n')),Object(r.b)("h2",{id:"dynamic-header-values"},"Dynamic Header Values"),Object(r.b)("p",null,"Mesh can take dynamic values from the GraphQL Context or the environmental variables. If you use ",Object(r.b)("inlineCode",{parentName:"p"},"mesh serve"),", GraphQL Context will be the incoming HTTP request."),Object(r.b)("p",null,"The expression inside dynamic values should be as in JS."),Object(r.b)("h3",{id:"from-context-http-header-for-mesh-serve"},"From Context (HTTP Header for ",Object(r.b)("inlineCode",{parentName:"h3"},"mesh serve"),")"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yml"},"sources:\n  - name: MyGraphQLApi\n    handler:\n      openapi:\n        source: ./my-schema.json\n        operationHeaders:\n          # Please do not use capital letters while getting the headers\n          Authorization: Bearer {context.headers['x-my-api-token']} \n          # You can also access to the cookies like below;\n          # Authorization: Bearer {context.cookies.myApiToken}\n")),Object(r.b)("p",null,"And for ",Object(r.b)("inlineCode",{parentName:"p"},"mesh serve"),", you can pass the value using ",Object(r.b)("inlineCode",{parentName:"p"},"x-my-graphql-api-token")," HTTP header."),Object(r.b)("h3",{id:"from-environmental-variable"},"From Environmental Variable"),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"MY_API_TOKEN")," is the name of the environmental variable you have the value."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yml"},"sources:\n  - name: MyGraphQLApi\n    handler:\n      openapi:\n        source: ./my-schema.json\n        operationHeaders:\n          Authorization: Bearer ${MY_API_TOKEN}\n")),Object(r.b)("h2",{id:"advanced-cookies-handling"},"Advanced cookies handling"),Object(r.b)("p",null,"When building a web application, for security reasons, cookies are often used for authentication. Mobile applications on the other end, tend to use a HTTP header."),Object(r.b)("p",null,"This section shows how to configure GraphQL Mesh to accept either, and also how to use GraphQL Mesh to set / unset cookies on the login & logout mutations."),Object(r.b)("h3",{id:"accepting-either-a-cookie-or-a-header"},"Accepting either a cookie or a header"),Object(r.b)("p",null,"We want to accept either a ",Object(r.b)("inlineCode",{parentName:"p"},"accessToken")," cookie or a ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization")," header, and transmit it to the Rest API as a ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization")," header. GraphQL Mesh does not allow dynamic selection in the ",Object(r.b)("inlineCode",{parentName:"p"},"meshrc.yaml")," file, but that's fine! We can use a bit of trickery."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yml"},"sources:\n  - name: Rest\n    handler:\n      openapi:\n        source: ./openapi.yaml\n        baseUrl: ${REST_API_URL}/api/\n        operationHeaders:\n          Authorization-Header: \"{context.headers['authorization']}\"\n          Authorization-Cookie: Bearer {context.cookies.accessToken}\n        customFetch: ./src/custom-fetch.js\n")),Object(r.b)("p",null,"Here in the ",Object(r.b)("inlineCode",{parentName:"p"},"meshrc.yaml")," configuration we store the cookie in ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization-Cookie"),", and the header in ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization-Header"),". Now to introduce the logic needed to generate the proper ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization")," header for the Rest API, we need to implement a ",Object(r.b)("inlineCode",{parentName:"p"},"customFetch"),". It will replace the ",Object(r.b)("inlineCode",{parentName:"p"},"fetch")," used by GraphQL Mesh to call the Rest API."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-js"},"const fetch = require('node-fetch')\n\nmodule.exports = function (url, args) {\n  // Set Authorization header dynamically to either the input cookie or input header\n  args.headers['authorization'] = args.headers['authorization-cookie'] ?? args.headers['authorization-header'];\n  // Clean up headers forwarded to the Rest API\n  delete args.headers['authorization-cookie'];\n  delete args.headers['authorization-header'];\n  // Execute the fetch with the new headers\n  return fetch(url, args)\n}\n")),Object(r.b)("p",null,"Of course, ",Object(r.b)("inlineCode",{parentName:"p"},"node-fetch")," needs to be added to your project: ",Object(r.b)("inlineCode",{parentName:"p"},"npm add node-fetch"),"."),Object(r.b)("h3",{id:"setting--unsetting-the-cookie"},"Setting / Unsetting the cookie"),Object(r.b)("p",null,"Of course, being able to use GraphQL Mesh as a Gateway for both the mobile application and web application is nice, but there's one thing missing: the setting of the cookie for the web application."),Object(r.b)("p",null,"For that, we need to access the HTTP response that is sent back to the client. Luckily, we can do so in ",Object(r.b)("inlineCode",{parentName:"p"},"additionalResolvers"),". So we need to create two new resolvers, one for login and one for logout, and manage the cookie in their code."),Object(r.b)("p",null,"The first step is to edit the ",Object(r.b)("inlineCode",{parentName:"p"},"meshrc.yaml")," file, add this at the end:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yml"},"additionalTypeDefs: |\n  extend type Mutation {\n    login(credentials: Credentials!): String\n    logout: Boolean\n  }\nadditionalResolvers:\n  - ./src/additional-resolvers.js\n")),Object(r.b)("p",null,"Then manage the cookie in the new resolvers:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-js"},"// lifespan of our cookie\nconst oneYear = 365 * 24 * 3600\n\nconst resolvers = {\n  Mutation: {\n    login: async (_root, args, { Rest, res }) => {\n      // Call the Rest API's login operation\n      const result = await Rest.api.accountLogin(args.credentials)\n      // if `result` contains a JWT token, you could instead decode it and set `Expires`\n      // to the JWT token's expiration date\n      res.set('Set-Cookie', `accessToken=${result}; Path=/; Secure; HttpOnly; Max-Age=${oneYear};`)\n\n      return result\n    },\n    logout: async (_root, _args, { res }) => {\n      // use old date to unset cookie\n      res.set('Set-Cookie', `accessToken=logout; Path=/; Secure; HttpOnly; Expires=Thu, 1 Jan 1970 00:00:00 GMT;`)\n\n      return true\n    },\n  },\n}\n\nmodule.exports = { resolvers }\n")),Object(r.b)("p",null,"There's a caveat: the Rest API's login operation cannot have the same name as the additional login mutation. In this example we assumed that the login operation of the Rest API was named ",Object(r.b)("inlineCode",{parentName:"p"},"accountLogin"),", thus avoiding the name conflict."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"We have a lot of examples for OpenAPI Handler;"),Object(r.b)("ul",{parentName:"blockquote"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://codesandbox.io/s/github/Urigo/graphql-mesh/tree/master/examples/openapi-javascript-wiki"},"JavaScript Wiki")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://codesandbox.io/s/github/Urigo/graphql-mesh/tree/master/examples/openapi-location-weather"},"Location Weather")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://codesandbox.io/s/github/Urigo/graphql-mesh/tree/master/examples/openapi-stackexchange"},"StackExchange")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://codesandbox.io/s/github/Urigo/graphql-mesh/tree/master/examples/openapi-stripe"},"Stripe")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://codesandbox.io/s/github/Urigo/graphql-mesh/tree/master/examples/openapi-subscriptions"},"Subscriptions Example with Webhooks")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://codesandbox.io/s/github/Urigo/graphql-mesh/tree/master/examples/openapi-youtrack"},"Youtrack")))),Object(r.b)("h2",{id:"config-api-reference"},"Config API Reference"),Object(r.b)("p",null,Object(r.b)("ul",{parentName:"p"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"source")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"Any"),", required) - A pointer to your API source - could be a local file, remote file or url endpoint"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"sourceFormat")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"String (json | yaml)"),") - Format of the source file"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"operationHeaders")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"JSON"),") - JSON object representing the Headers to add to the runtime of the API calls"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"schemaHeaders")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"JSON"),") - If you are using a remote URL endpoint to fetch your schema, you can set headers for the HTTP request to fetch your schema."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"baseUrl")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"String"),") - Specifies the URL on which all paths will be based on.\nOverrides the server object in the OAS."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"qs")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"JSON"),") - JSON object representing the query search parameters to add to the API calls"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"customFetch")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"Any"),") - W3 Compatible Fetch Implementation"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"includeHttpDetails")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"Boolean"),") - Include HTTP Response details to the result object"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"addLimitArgument")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"Boolean"),") - Auto-generate a 'limit' argument for all fields that return lists of objects, including ones produced by links"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"genericPayloadArgName")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"Boolean"),") - Set argument name for mutation payload to 'requestBody'. If false, name defaults to camelCased pathname"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"selectQueryOrMutationField")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"Array of Object"),") - Allows to explicitly override the default operation (Query or Mutation) for any OAS operation: ",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"title")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"String"),") - OAS Title"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"path")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"String"),") - Operation Path"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"type")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"String (Query | Mutation)"),") - Target Root Type for this operation"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"method")," (type: ",Object(r.b)("inlineCode",{parentName:"li"},"String"),") - Which method is used for this operation"))))))}s.isMDXComponent=!0},338:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return h}));var a=n(0),o=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=o.a.createContext({}),s=function(e){var t=o.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=s(e.components);return o.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},u=o.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),b=s(n),u=a,h=b["".concat(i,".").concat(u)]||b[u]||d[u]||r;return n?o.a.createElement(h,l(l({ref:t},p),{},{components:n})):o.a.createElement(h,l({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);